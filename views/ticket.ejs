<%- include("layout") %>
<main class="main">
    <div class="ticket-contenedor">
        <% if (tickets.length > 0) { %>
            <% tickets.forEach(ticket => { %>
                <div class="ticket-card">
                    <!-- Barra superior con color según prioridad -->
                    <div class="priority-bar 
                        <% if (ticket.prioridad === 'Alta') { %> urgente-bar <% } %>
                        <% if (ticket.prioridad === 'Media') { %> media-bar <% } %>
                        <% if (ticket.prioridad === 'Baja') { %> baja-bar <% } %>
                    ">
                        <% if (ticket.prioridad === 'Alta') { %>
                            <span class="priority-text">Prioridad Urgente</span>
                        <% } else if (ticket.prioridad === 'Media') { %>
                            <span class="priority-text">Prioridad Media</span>
                        <% } else if (ticket.prioridad === 'Baja') { %>
                            <span class="priority-text"> Prioridad Baja</span>
                        <% } %>
                    </div>

                    <div class="ticket-info">         
                        <!-- <div class="icono">
                            <i class="fa-solid fa-circle-user"></i>
                            <p><%= ticket.empleado ? ticket.empleado : 'Sin asignar' %></p>
                        </div> -->

                        <div class="ticket-details">
                            <h2><%= ticket.nombre_problemas %></h2>
                            <!-- <p><strong>Descripción:</strong> <%= ticket.descripcion %></p>
                            <p><strong>Prioridad:</strong> 
                                <% if (ticket.prioridad === 'Alta') { %>
                                    <span class="urgente"><i class="fa-solid fa-stop" style="color: #f41049;"></i> Urgente</span>
                                <% } else if (ticket.prioridad === 'Media') { %>
                                    <span class="media"><i class="fa-solid fa-stop" style="color: #f47e10;"></i> Media</span>
                                <% } else if (ticket.prioridad === 'Baja') { %>
                                    <span class="baja"><i class="fa-solid fa-stop" style="color: #41c837;"></i> Baja</span>
                                <% } else { %>
                                    <span>Sin prioridad</span>
                                <% } %>
                            </p> -->
                            <div class="icono">
                                <i class="fa-solid fa-circle-user"></i>
                                <p><%= ticket.empleado ? ticket.empleado : 'Sin asignar' %></p>
                            </div>
                            <div class="button-container">
                                <button class="btn detalles-btn" onclick="AbrirDetallesModal('<%= ticket.id %>')">
                                    <i class="fa-solid fa-eye"></i> Ver detalles
                                </button>
                                <button class="btn detalles-btn" onclick="AbrirModal('<%= ticket.id %>')">
                                    <i class="fa-solid fa-plus"></i> Asignar
                                </button>
                            </div>
                            <h5><%= ticket.fecha_creacion %></h5>
                        </div>
                    </div>
                    <span class="ticket-id">#<%= ticket.id %></span>
                </div>
            <% }) %>
        <% } else { %>
            <p>No hay tickets pendientes.</p>
        <% } %>
    </div>
</main>



<!-- Modal para asignar técnico -->
<div class="modal" id="modal">
    <div class="modal2-content">
        <div class="title-modal2">Asignar Tecnico</div>
        <span id="claseModalBtn" onclick="closeModal()" class="close">
            <i class="fa-solid fa-xmark"></i>
        </span>
        <form id="asignarForm" action="" method="POST">
            <label for="tecnico_id">Seleccionar Técnico:</label>
            <select name="tecnico_id" id="tecnico_id" required>
                <% tecnicos.forEach(tecnico => { %>
                    <option value="<%= tecnico.id %>"><%= tecnico.nombre %></option>
                <% }) %>
            </select>
            <div class="button-modal2">
                <input type="submit" value="Asignar">
            </div>
            <!-- <button type="submit" class="btn-modal">Asignar</button> -->
        </form>
        <!-- <button class="btn" onclick="closeModal()">Cerrar</button> -->
    </div>
</div>

<!-- Modal para Ver Detalles -->
<div class="modal" id="ticketModal">
    <div class="modal2-content">
        <div class="title-modal2">Detalles del ticket</div>
        <span id="claseModalBtn" onclick="closeModal()" class="close">
            <i class="fa-solid fa-xmark"></i>
        </span>
        <form id="detallesForm">
            <div class="user-details">
                <div class="input-box">
                    <label for="modal-nombre-problema">Nombre del problema:</label>
                    <span id="modal-nombre-problema" class="details"></span>

                    <label for="modal-descripcion">Descripción:</label>
                    <span id="modal-descripcion" class="details"></span>

                    <label for="modal-fecha-creacion">Fecha de creación:</label>
                    <span id="modal-fecha-creacion" class="details"></span>
                </div>
            </div>
        </form>
    </div>
</div>


<script>
function AbrirModal(ticketId) {
    document.getElementById("modal").style.display = "flex";
    document.getElementById("asignarForm").action = "/asignar/" + ticketId;
}
function AbrirDetallesModal(ticketId) {
    // Obtener el ticket por ID
    fetch(`/ticket/${ticketId}`)
        .then(response => response.json())
        .then(ticket => {
            // Llenar los campos del modal con los datos del ticket
            document.getElementById("modal-nombre-problema").textContent = ticket.nombre_problemas;
            document.getElementById("modal-descripcion").textContent = ticket.descripcion || "Sin descripción disponible";
            document.getElementById("modal-fecha-creacion").textContent = ticket.fecha_creacion;

            // Mostrar el modal de detalles
            document.getElementById("ticketModal").style.display = "flex";
        })
        .catch(error => {
            console.error('Error al obtener el ticket:', error);
        });
}

function closeModal() {
    document.getElementById("modal").style.display = "none";
    document.getElementById("ticketModal").style.display = "none";
}
</script>



